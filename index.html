<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workout Timer</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
    }

    #exercise-container {
      height: 10rem;
      min-height: 70px;
      max-width: 800px;
      width: 90%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    #exercise {
      word-wrap: break-word;
    }

    #timer {
      font-weight: bold;
      margin: 25px 0;
    }

    .progress-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 600px;
      height: 28px;
      background: #333;
      border-radius: 14px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: #4caf50;
      transition: width 0.4s ease;
    }

    .button-container {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 25px;
    }

    button {
      font-size: 2rem;
      padding: 15px 25px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      border-radius: 8px;
      background: #222;
      color: #fff;
    }

    button:active {
      background: #333;
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    @media (max-width: 600px) {
      #exercise { font-size: 10vw; }
      #timer { font-size: 12vw; }
    }

    @media (min-width: 601px) {
      #exercise { font-size: 6rem; }
      #timer { font-size: 8rem; }
    }
  </style>
</head>

<body>

<canvas id="confetti"></canvas>

<div id="exercise-container">
  <div id="exercise">Press Play!</div>
</div>

<div id="timer">--</div>

<div class="button-container">
  <button id="replay">Replay</button>
  <button id="pause">Play ►</button>
  <button id="skip">Skip</button>
</div>

<div class="progress-container">
  <div class="progress-bar" id="progress-bar"></div>
</div>

<script>
// ===================== CONFIG =====================
const exercises = [
  "Jumping Jacks", "Wall Sit", "Push Ups", "Sit Ups", "Step Up",
  "Squat", "Triceps Dip", "Plank", "Jumping Jacks", "Wall Sit",
  "Downward Dog Cobra", "Bicycle Kicks", "Side-to-Side Shuffle",
  "Lunge", "Push Up & Rotation", "Crunch"
];

const WORK_TIME = 26;
const TRANSITION_TIME = 8;

// ===================== ENCOURAGEMENT =====================
const encouragements = [
  "Fifteen seconds left",
  "Halfway there",
  "Keep going",
  "You're doing great",
  "Finish strong."
];

let encouragementIndex = 0;
let encouragementSpoken = false;

function speakEncouragement() {
  speak(encouragements[encouragementIndex]);
  encouragementIndex = (encouragementIndex + 1) % encouragements.length;
}

// ===================== STATE =====================
let currentExercise = 0;
let timeLeft = TRANSITION_TIME;
let phase = "ready";
let paused = true;
let started = false;
let interval = null;
let confettiPlayed = false;

// ===================== AUDIO =====================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let calmVoice = null;
let voicesReady = false;

function enableAudio() {
  if (audioCtx.state === "suspended") audioCtx.resume();
}

function beep(freq = 500, duration = 180) {
  enableAudio();
  const osc = audioCtx.createOscillator();
  osc.frequency.value = freq;
  osc.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration / 1000);
}

// ===================== VOICE =====================
function loadMaleVoice() {
  return new Promise(resolve => {
    function tryLoad() {
      const voices = speechSynthesis.getVoices();
      if (!voices.length) return false;
      calmVoice = voices.find(v => v.lang.startsWith("en")) || voices[0];
      voicesReady = true;
      resolve();
      return true;
    }
    if (!tryLoad()) speechSynthesis.onvoiceschanged = tryLoad;
  });
}

function speak(text) {
  if (!voicesReady || !calmVoice) return;
  enableAudio();
  speechSynthesis.cancel();
  const msg = new SpeechSynthesisUtterance(text);
  msg.voice = calmVoice;
  msg.rate = 0.85;
  msg.pitch = 0.8;
  speechSynthesis.speak(msg);
}

// ===================== UI =====================
const exerciseEl = document.getElementById("exercise");
const timerEl = document.getElementById("timer");
const pauseBtn = document.getElementById("pause");
const progressBar = document.getElementById("progress-bar");

// ===================== FLOW =====================
function updateTimer() {
  timerEl.textContent = timeLeft.toString().padStart(2, "0");
}

function updateProgressBar() {
  progressBar.style.width = (currentExercise / exercises.length) * 100 + "%";
}

function startGetReady() {
  phase = "ready";
  timeLeft = TRANSITION_TIME;
  exerciseEl.textContent = "Get Ready";
  speak("Get ready");
  updateTimer();
}

function startExercise() {
  phase = "work";
  timeLeft = WORK_TIME;
  encouragementSpoken = false;
  exerciseEl.textContent = exercises[currentExercise];
  speak(exercises[currentExercise]);
  updateTimer();
}

function startTransition() {
  phase = "transition";
  timeLeft = TRANSITION_TIME;
  exerciseEl.textContent = `Next Up: ${exercises[currentExercise]}`;
  speak(`Next up: ${exercises[currentExercise]}`);
  updateTimer();
}

function finishWorkout() {
  phase = "complete";
  exerciseEl.textContent = "Workout Complete!";
  timerEl.textContent = "✔";
  progressBar.style.width = "100%";
  clearInterval(interval);
  pauseBtn.textContent = "Restart ↺";
  speak("Workout complete. Great job!");
}

// ===================== TICK =====================
function tick() {
  if (!started || paused) return;

  if ([3, 2, 1].includes(timeLeft)) beep();

  if (phase === "work" && !encouragementSpoken) {
    if (timeLeft === Math.floor(WORK_TIME / 2)) {
      speakEncouragement();
      encouragementSpoken = true;
    }
  }

  if (timeLeft === 0) {
    if (phase === "ready") return startExercise();

    if (phase === "work") {
      currentExercise++;
      updateProgressBar();
      if (currentExercise >= exercises.length) return finishWorkout();
      return startTransition();
    }

    if (phase === "transition") return startExercise();
  }

  timeLeft--;
  updateTimer();
}

// ===================== CONTROLS =====================
pauseBtn.onclick = async () => {
  enableAudio();

  if (!started || phase === "complete") {
    currentExercise = 0;
    encouragementIndex = 0;
    progressBar.style.width = "0%";
    pauseBtn.textContent = "Pause ❚❚";
    started = true;
    paused = false;
    await loadMaleVoice();
    startGetReady();
    interval = setInterval(tick, 1000);
    return;
  }

  paused = !paused;
  pauseBtn.textContent = paused ? "Play ►" : "Pause ❚❚";
};

document.getElementById("skip").onclick = () => {
  if (phase === "work") {
    currentExercise++;
    updateProgressBar();
    if (currentExercise >= exercises.length) return finishWorkout();
    startTransition();
  }
};

document.getElementById("replay").onclick = () => {
  if (phase !== "work") return;
  timeLeft = WORK_TIME;
  encouragementSpoken = false;
  updateTimer();
};
</script>

</body>
</html>
